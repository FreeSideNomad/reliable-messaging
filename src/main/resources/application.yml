micronaut:
  application:
    name: reliable-single
  server:
    port: 8080
    # Thread pool configuration - reasonable defaults for JDBC blocking operations
    thread-selection: AUTO
    netty:
      # Worker threads - handles I/O operations
      # For JDBC blocking operations, high thread count for 1000+ TPS
      worker:
        threads: ${NETTY_WORKER_THREADS:2000}
      # Parent threads - accepts connections
      parent:
        threads: ${NETTY_PARENT_THREADS:16}
      # Buffer sizes for better throughput
      max-initial-line-length: 8192
      max-header-size: 16384
      max-chunk-size: 16384
      initial-buffer-size: 256
      # Compression settings
      compression-threshold: 1024
      compression-level: 6
      # HTTP/2 settings
      http2:
        max-concurrent-streams: 100
  test-resources:
    enabled: false

datasources:
  default:
    enabled: true
    url: jdbc:postgresql://${POSTGRES_HOST:localhost}:${POSTGRES_PORT:5432}/${POSTGRES_DB:reliable}
    username: ${POSTGRES_USER:postgres}
    password: ${POSTGRES_PASSWORD:postgres}
    driverClassName: org.postgresql.Driver
    # HikariCP connection pool configuration
    # Formula: (core_count Ã— 2) + effective_spindle_count
    # For very high load: 2000 connections for 650 TPS with 2000 threads
    maximum-pool-size: ${HIKARI_MAX_POOL_SIZE:2000}
    minimum-idle: ${HIKARI_MIN_IDLE:400}
    # Connection timeout
    connection-timeout: 30000
    # Idle timeout (10 minutes)
    idle-timeout: 600000
    # Max lifetime (30 minutes)
    max-lifetime: 1800000
    # Leak detection threshold
    leak-detection-threshold: 60000

flyway:
  datasources:
    default:
      enabled: true

jms:
  consumers:
    enabled: true

kafka:
  bootstrap:
    servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
  producers:
    default:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
  required-topics: ${KAFKA_REQUIRED_TOPICS:events.CreateUser}
  topic-partitions: ${KAFKA_TOPIC_PARTITIONS:3}
  topic-replication-factor: ${KAFKA_TOPIC_REPLICATION_FACTOR:1}

jpa:
  default:
    properties:
      hibernate.hbm2ddl.auto: none

# Messaging configuration
messaging:
  queue-naming:
    command-prefix: ${MQ_COMMAND_PREFIX:APP.CMD.}
    queue-suffix: ${MQ_QUEUE_SUFFIX:.Q}
    reply-queue: ${MQ_REPLY_QUEUE:APP.CMD.REPLY.Q}
  topic-naming:
    event-prefix: ${KAFKA_EVENT_PREFIX:events.}

# Timeout configuration
timeout:
  command-lease: ${COMMAND_LEASE_DURATION:5m}    # How long a command is leased for processing
  max-backoff: ${MAX_BACKOFF_DURATION:5m}        # Maximum backoff time for outbox retries
  sync-wait: ${SYNC_WAIT_DURATION:0s}            # HTTP sync wait for command response (0 = fully async)
  outbox-batch-size: ${OUTBOX_BATCH_SIZE:2000}   # Outbox relay batch size (4x increased from 500)

# MQ configuration
mq:
  required-queues: ${MQ_REQUIRED_QUEUES:APP.CMD.CreateUser.Q,APP.CMD.REPLY.Q}
